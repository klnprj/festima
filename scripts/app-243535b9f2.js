!function(){"use strict";angular.module("festima",["ngMessages","ngRoute","ui.router","ngAnimate","ngSanitize","ui.bootstrap","toastr","ui.select","angular-oauth2","angularSpinners"])}(),function(){"use strict";function e(){function e(){return t}var t=[{title:"AngularJS",url:"https://angularjs.org/",description:"HTML enhanced for web apps!",logo:"angular.png"},{title:"BrowserSync",url:"http://browsersync.io/",description:"Time-saving synchronised browser testing.",logo:"browsersync.png"},{title:"GulpJS",url:"http://gulpjs.com/",description:"The streaming build system.",logo:"gulp.png"},{title:"Jasmine",url:"http://jasmine.github.io/",description:"Behavior-Driven JavaScript.",logo:"jasmine.png"},{title:"Karma",url:"http://karma-runner.github.io/",description:"Spectacular Test Runner for JavaScript.",logo:"karma.png"},{title:"Protractor",url:"https://github.com/angular/protractor",description:"End to end test framework for AngularJS applications built on top of WebDriverJS.",logo:"protractor.png"},{title:"Bootstrap",url:"http://getbootstrap.com/",description:"Bootstrap is the most popular HTML, CSS, and JS framework for developing responsive, mobile first projects on the web.",logo:"bootstrap.png"},{title:"Angular UI Bootstrap",url:"http://angular-ui.github.io/bootstrap/",description:"Bootstrap components written in pure AngularJS by the AngularUI Team.",logo:"ui-bootstrap.png"}];this.getTec=e}angular.module("festima").service("webDevTec",e)}(),function(){"use strict";function e(){function e(e,t){var n=this;t.profile().then(function(e){n.user=e}),n.relativeDate=e(n.creationDate).fromNow()}e.$inject=["moment","session"];var t={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return t}angular.module("festima").directive("acmeNavbar",e)}(),angular.module("festima").controller("MessagesModalController",["$scope","$uibModalInstance","position","messages","onNewMessage",function(e,t,n,i,r){var o=this;o.messages=i,o.onNewMessage=r,o.ok=function(){t.close(n)},o.cancel=function(){t.dismiss("cancel")},o.addNewMessage=function(){o.onNewMessage(o.newMessage),o.newMessage={}}}]),angular.module("festima").controller("MessagesButtonController",["$uibModal","$log","moment","Message","messagesManager","session",function(e,t,n,i,r,o){var a=this;a.openMessages=function(){var n;r.loadAllMessages(a.position.id).then(function(i){a.messages=i,n=e.open({animation:!0,templateUrl:"app/components/messagesButton/messages-modal.html",controller:"MessagesModalController",controllerAs:"messagesModalVm",size:"lg",resolve:{position:function(){return a.position},messages:function(){return a.messages},onNewMessage:function(){return a.addMessage}}}),n.result.then(function(e){},function(){t.info("Modal dismissed at: "+new Date)})})},a.addMessage=function(e){var t=new i(angular.extend(e,{authorId:o.userId(),positionId:a.position.id,dateCreated:n().format()}));t.save().then(function(e){r.getMessage(e).then(function(e){a.messages.push(e)})})}}]),angular.module("festima").component("messagesButton",{templateUrl:"app/components/messagesButton/messages-button.html",bindings:{position:"<"},controller:"MessagesButtonController",controllerAs:"messagesButtonVm"}),function(){"use strict";function e(e){function t(t,n,i,r){var o,a=e(n[0],{typeSpeed:40,deleteSpeed:40,pauseDelay:800,loop:!0,postfix:" "});n.addClass("acme-malarkey"),angular.forEach(t.extraValues,function(e){a.type(e).pause()["delete"]()}),o=t.$watch("vm.contributors",function(){angular.forEach(r.contributors,function(e){a.type(e.login).pause()["delete"]()})}),t.$on("$destroy",function(){o()})}function n(e,t){function n(){return i().then(function(){e.info("Activated Contributors View")})}function i(){return t.getContributors(10).then(function(e){return r.contributors=e,r.contributors})}var r=this;r.contributors=[],n()}n.$inject=["$log","githubContributor"];var i={restrict:"E",scope:{extraValues:"="},template:"&nbsp;",link:t,controller:n,controllerAs:"vm"};return i}e.$inject=["malarkey"],angular.module("festima").directive("acmeMalarkey",e)}(),function(){"use strict";function e(e,t){function n(n){function r(e){return e.data}function o(t){e.error("XHR Failed for getContributors.\n"+angular.toJson(t.data,!0))}return n||(n=30),t.get(i+"/contributors?per_page="+n).then(r)["catch"](o)}var i="https://api.github.com/repos/Swiip/generator-gulp-angular",r={apiHost:i,getContributors:n};return r}e.$inject=["$log","$http"],angular.module("festima").factory("githubContributor",e)}(),function(e){"use strict";function t(e,t,n,i){i.key=n[this.name]}function n(e,t){var n=this;n.items=[],n.trustAsHtml=function(t){return e.trustAsHtml(t)},n.refreshItems=function(e){t.itemsByKey(n.key,void 0,void 0,e).then(function(e){n.items=e})},n.refreshItems()}t.$inject=["scope","element","attrs","controller"],n.$inject=["$sce","dictionaries"],e.component("esDictionaryAutocomplete",{templateUrl:"app/components/dictionaryAutocomplete/dictionary-autocomplete.html",bindings:{key:"@",selected:"="},controller:n,controllerAs:"vm"})}(angular.module("festima")),function(e){function t(e,t){var n=this;n.items=[],n.newItem={},n.currentPage=1,n.itemsPerPage=3,n.add=function(e){t.addItem(n.key,e).then(function(e){n.newItem={},n.pageChanged()})},n.pageChanged=function(){var i=t.itemsByKey(n.key,(n.currentPage-1)*n.itemsPerPage,n.itemsPerPage),r=t.countItemsByKey(n.key);e.all({items:i,count:r}).then(function(e){n.items=e.items,n.totalItems=e.count})},n.pageChanged()}t.$inject=["$q","dictionaries"],e.component("esDictionary",{templateUrl:"app/components/dictionary/dictionary.html",bindings:{key:"<"},controllerAs:"dictionaryVm",controller:t})}(angular.module("festima")),angular.module("festima").controller("DealerPositionsController",function(){var e=this;angular.extend(e,{addNewPosition:function(){var t=angular.copy(e.newPosition);angular.extend(t,e.inputPosition),e.inputPosition={},e.onAddPosition({dealerId:t.dealerId,position:t})},removePosition:function(t){e.onDeletePosition({dealerId:t.dealer.id,position:t})},activePosition:function(e){return void 0===e.removed}})}),angular.module("festima").component("esDealerPositions",{templateUrl:"app/components/dealerPositions/dealer-positions.html",bindings:{positions:"<",newPosition:"<",onAddPosition:"&",onDeletePosition:"&"},controller:"DealerPositionsController",controllerAs:"positionsVm",transclude:!0}),function(e){"use strict";function t(e,t){var n=this,i=function(i){var r;i&&(r=e.centroidToLatlng(i.geometry.centroid),t.listWithinRadius(r,1e3).then(function(e){n.buildings=e}))};Object.defineProperty(n,"address",{get:function(){return n._address},set:function(e){n._address=e,i(e)}})}t.$inject=["maps","addresses"],e.component("esBuildingsNearby",{templateUrl:"app/components/buildingsNearby/buildings-nearby.html",bindings:{address:"<"},controllerAs:"vm",controller:t})}(angular.module("festima")),angular.module("festima").controller("BuildingFormController",function(){}),angular.module("festima").component("esBuildingForm",{templateUrl:"app/components/buildingForm/building-form.html",bindings:{building:"<"},controller:"BuildingFormController",controllerAs:"buildingFormVm",transclude:!0}),angular.module("festima").service("buildingDealersService1",["dealers","positions",function(e,t){var n,i,r,o={},a={};angular.extend(this,{buildingDealersMap:o,loadPositions:function(e){t.list1(e).then(function(e){n=e.data;for(var t,i=0;i<n.length;i++)t=n[i].dealerId,void 0===o[t]&&(o[t]={name:a[t].name,positions:[]}),o[t].positions.push(n[i])},function(e){console.log("couldn't load positions")})},savePositions:function(){var e,n;for(var i in o){e=o[i];for(var r=0;r<e.positions.length;r++)n=e.positions[r],void 0===n.buildingId&&(n.buildingId=n.building.id,delete n.building),void 0===n.id&&t.create1(n).then(function(e){n.id=e.data.id,console.log("Saved position "+n.id)}),n.removed===!0&&t["delete"](n.id).then(function(t){var i=e.positions.map(function(e){return e.id}).indexOf(n.id);e.positions.splice(i,1)})}},addDealerPosition:function(e,t){o[e].positions.push(t)},removeDealerPosition:function(e,t){var n=o[e];if(void 0===t.id){var i=n.positions.indexOf(t);-1!==i&&n.positions.splice(i,1)}else t.removed=!0},dealers:r,loadDealers:function(){e.list().then(function(e){i=e.data;for(var t,n=0;n<i.length;n++)t=i[n],void 0===a[t.id]&&(a[t.id]=t)})},refreshDealers:function(t){e.list().then(function(e){r=e.data;for(var t,n=0;n<r.length;n++)t=r[n],void 0===a[t.id]&&(a[t.id]=t)})},addDealer:function(e){var t=Object.keys(o).indexOf(e.id);-1===t&&(o[e.id]={name:e.name,positions:[]})}})}]),angular.module("festima").controller("AddDealerButtonController",["dealers",function(e){var t=this;t.addDealer=function(){t.onCheckAdded({dealer:t.dealer})||t.onAddDealer({dealer:t.dealer}),t.dealer=void 0},t.refreshDealers=function(n){e.findAllByQuery().then(function(e){t.dealers=e})}}]),angular.module("festima").component("esAddDealerButton",{templateUrl:"app/components/addDealerButton/add-dealer-button.html",bindings:{onAddDealer:"&",onCheckAdded:"&"},controller:"AddDealerButtonController",controllerAs:"addDealerVm"}),angular.module("festima").controller("BuildingAddressController",["maps",function(e){var t,n=this;angular.isDefined(n.building)&&(n.asyncSelected=n.building.address),DG.then(function(){angular.isDefined(n.building)&&angular.isDefined(n.building.location)&&(t=e.centroidToLatlng(n.building.location)),e.initMap(t).then(function(t){n.map=t,n.map.on("click",function(t){var i=[t.latlng.lat,t.latlng.lng];console.log(i),e.searchCoords(i).then(function(t){n.location=t,n.address=t.name,"undefined"!=typeof n.marker&&n.map.removeLayer(n.marker),n.marker=e.getMarker(i);var r=t.name+".<br />";r+=t.attributes.buildingname,n.marker.bindPopup(r),n.marker.addTo(n.map)})})})}),n.searchAddress=function(t){e.searchAddress(t).then(function(t){"undefined"!=typeof n.marker&&n.map.removeLayer(n.marker),n.marker=e.getMarker(t),n.map.addLayer(n.marker),n.map.panTo(t)})},n.getLocation=function(t){return e.suggestions(t).then(function(e){return e.map(function(e){return e})})},n.onSelect=function(t,i,r){e.search(t.hint.text).then(function(t){var i=t[0];"undefined"!=typeof n.marker&&n.map.removeLayer(n.marker);var r=e.centroidToLatlng(i.geometry.centroid);n.marker=e.getMarker(r),n.map.addLayer(n.marker),n.map.panTo(r),n.asyncSelected=i.full_name,n.onAddressSelected({address:i})})}}]),angular.module("festima").component("esBuildingAddress",{templateUrl:"app/components/buildingAddress/building-address.html",bindings:{building:"<",onAddressSelected:"&"},controllerAs:"addressVm",controller:"BuildingAddressController"}),angular.module("festima").factory("usersManager",["$http","$q","appConfig","User",function(e,t,n,i){var r={},o={_pool:{},_retrieveInstance:function(e,t){var n=this._pool[e];return n?n.setData(t):(n=new i(t),this._pool[e]=n),n},_search:function(e){return this._pool[e]},getUser:function(t){return angular.isUndefined(r[t])&&(r[t]=e.get(n.apiUrl+"/users/"+t).then(function(e){return e.data})),r[t]},loadAllUsers:function(){var i=t.defer(),r=this;return e.get(n.apiUrl+"/users").success(function(e){var t=[];e.forEach(function(e){var n=r._retrieveInstance(e.id,e);t.push(n)}),i.resolve(t)}).error(function(){i.reject()}),i.promise},setUser:function(e){var t=this,n=this._search(e.id);return n?n.setData(e):n=t._retrieveInstance(e),n}};return o}]),angular.module("festima").factory("User",["$http","appConfig",function(e,t){function n(e){e&&this.setData(e)}return n.prototype={setData:function(e){angular.extend(this,e)},save:function(){return e.post(t.apiUrl+"/users",this)},"delete":function(){e["delete"](t.apiUrl+"/users/"+this.id)},update:function(){e.put(t.apiUrl+"/users/"+this.id,this)}},n}]),angular.module("festima").factory("messagesManager",["$http","$q","Message","usersManager","appConfig",function(e,t,n,i,r){var o={_pool:{},_retrieveInstance:function(e,t){var i=this._pool[e];return i?i.setData(t):(i=new n(t),this._pool[e]=i),i},_search:function(e){return this._pool[e]},_load:function(t,n){var o=this;e.get(r.apiUrl+"/messages/"+t).success(function(e){var t,r=e;i.getUser(r.author.id).then(function(e){r.author=e,t=o._retrieveInstance(r.id,r),n.resolve(t)})}).error(function(){n.reject()})},getMessage:function(e){var n=t.defer(),i=this._search(e);return i?n.resolve(i):this._load(e,n),n.promise},loadAllMessages:function(n){var o=t.defer(),a=this;return e.get(r.apiUrl+"/messages",{params:{positionId:n}}).success(function(e){var t,n=[];return 0==e.length?void o.resolve([]):void e.forEach(function(e){i.getUser(e.author.id).then(function(i){e.author=i,t=a._retrieveInstance(e.id,e),n.push(t)}).then(function(){o.resolve(n)})})}).error(function(){o.reject()}),o.promise},setMessage:function(e){var t=this,n=this._search(e.id);return n?n.setData(e):n=t._retrieveInstance(e),n}};return o}]),angular.module("festima").service("messages",["$http",function(e){angular.extend(this,{})}]),angular.module("festima").factory("Message",["$http","$q","appConfig",function(e,t,n){function i(e){e&&this.setData(e)}return i.prototype={setData:function(e){angular.extend(this,e)},save:function(){var i=t.defer(),r=this;return void 0===this.id?e.post(n.apiUrl+"/messages",this).then(function(e){angular.extend(r,e.data),i.resolve(r.id)},function(e){i.reject()}):(this.update(),i.resolve(this.id)),i.promise},"delete":function(){e["delete"](n.apiUrl+"/messages/"+this.id)},update:function(){e.put(n.apiUrl+"/messages/"+this.id,this)}},i}]),function(){angular.module("festima").service("maps",["$q",function(e){var t;angular.extend(this,{dgis:t,initMap:function(n){var i=e.defer();return angular.isUndefined(n)&&(n=[54.981,82.891]),DG.then(function(){t=DG;var e=t.map("map",{center:n,zoom:16,geoclicker:!0,showPhotos:!1,showBooklet:!1});t.marker(n).addTo(e).bindPopup("Clicked!"),i.resolve(e)},function(){i.reject()}),i.promise},suggestions:function(n){var i=e.defer();return t.ajax({url:"http://catalog.api.2gis.ru/2.0/suggest/list",data:{key:"ruczoy1743",output:"json",region_id:32,q:n},type:"GET",success:function(e){i.resolve(e.result.items)},error:function(e){console.log(e),i.reject()}}),i.promise},getById:function(n){var i=e.defer();return t.ajax({url:"http://catalog.api.2gis.ru/2.0/geo/get",data:{key:"ruczoy1743",id:n,fields:"items.geometry.centroid"},type:"GET",success:function(e){i.resolve(e.result.items[0])},error:function(e){console.log(e),i.reject()}}),i.promise},searchAddress:function(n){var i,r,o,a=e.defer();return t.ajax({url:"http://catalog.api.2gis.ru/geo/search",data:{key:"ruczoy1743",version:1.3,q:n},type:"GET",success:function(e){i=t.Wkt.toPoints(e.result[0].centroid),r=i[0],o=i[1],a.resolve([o,r])},error:function(e){console.log(e),a.reject()}}),a.promise},searchCoords:function(n){var i=e.defer();return t.ajax({url:"http://catalog.api.2gis.ru/geo/search",data:{key:"ruczoy1743",version:1.3,q:n[1]+","+n[0]},success:function(e){i.resolve(e.result[0])},error:function(e){console.log(e),i.reject()}}),i.promise},getMarker:function(e){return t.marker(e)},centroidToLatlng:function(e){var t=DG.Wkt.toPoints(e);return[t[1],t[0]]},search:function(n){var i=e.defer();return t.ajax({url:"http://catalog.api.2gis.ru/2.0/geo/search",data:{key:"ruewin2963",q:n,region_id:32,fields:"hash,search_attributes,items.address,items.adm_div,items.geometry.centroid,items.geometry.selection,items.geometry.style,items.floors,items.group"},success:function(e){i.resolve(e.result.items)},error:function(e){console.log(e),i.reject()}}),i.promise}})}])}(),function(){"use strict";function e(e,t,n){function i(){o(),e(function(){a.classAnimation="rubberBand"},4e3)}function r(){n.info("Уведомление..."),a.classAnimation=""}function o(){a.awesomeThings=t.getTec(),angular.forEach(a.awesomeThings,function(e){e.rank=Math.random()})}var a=this;a.awesomeThings=[],a.classAnimation="",a.creationDate=1457814815376,a.showToastr=r,i()}e.$inject=["$timeout","webDevTec","toastr"],angular.module("festima").controller("MainController",e)}(),angular.module("festima").controller("AboutController",function(){}),function(e){"use strict";e.service("session",["$http","$log","$q","$state","$rootScope","$timeout","$cookies","appConfig","OAuth","OAuthToken",function(e,t,n,i,r,o,a,s,l,u){function c(t){return e.get(s.apiUrl+"/users",{params:{email:t}}).then(function(e){var t=e.data[0];return p=t.id,t})}var d,g,p;angular.extend(this,{login:function(e){var n={};return angular.extend(e,{scope:"read"}),l.getAccessToken(e,n).then(function(t){g=e.username,d=c(g)})["catch"](function(e){t.error("Auth error: ",e)})},logout:function(){return a.remove("token"),o(function(){i.go("public.login")})},userId:function(){return p},profile:function(){return d||(d=c(g)),d},isAuthenticated:function(){return l.isAuthenticated()},checkLoggedIn:function(){var e=n.defer();return this.isAuthenticated()?e.resolve():(o(function(){i.go("public.login")}),e.reject()),e.promise},skipLoggedIn:function(){var e=n.defer();return this.isAuthenticated()?e.reject():e.resolve(),e.promise}})}])}(angular.module("festima")),function(e){"use strict";e.controller("LoginController",["$http","$state","appConfig","OAuth","OAuthToken","spinnerService","session",function(e,t,n,i,r,o,a){var s=this;s.login=function(){var e={username:s.email,password:s.password};a.login(e).then(function(){t.go("private.main")})["finally"](function(){})},s.logout=function(){a.logout()}}])}(angular.module("festima")),function(e){"use strict";e.controller("DictionaryShowController",["$stateParams","dictionaries",function(e,t){var n=this;console.log("State params: ",e.key),n.key=e.key,t.loadByKey(e.key).then(function(e){n.dictionary=e})}])}(angular.module("festima")),function(e){"use strict";e.service("dictionaries",["$q","$http","appConfig",function(e,t,n){angular.extend(this,{listAll:function(){return t.get(n.apiUrl+"/dictionaries").then(function(e){return e.data})},loadByKey:function(e){return t.get(n.apiUrl+"/dictionaries/"+e).then(function(e){return e.data})},itemsByKey:function(e,i,r,o){return t.get(n.apiUrl+"/dictionaries/"+e+"/items",{params:{offset:i,max:r,q:o}}).then(function(e){return e.data})},countItemsByKey:function(e){return t.get(n.apiUrl+"/dictionaries/"+e+"/count").then(function(e){return e.data})},addItem:function(e,i){return t.post(n.apiUrl+"/dictionaries/"+e+"/items",{data:i}).then(function(e){return e.data})},loadItem:function(e){return t.get(n.apiUrl+"/dictionaries/items/"+e).then(function(e){return e.data})}})}])}(angular.module("festima")),function(e){"use strict";e.controller("DictionaryListController",["dictionaries",function(e){var t=this;e.listAll().then(function(e){t.dictionaries=e})}])}(angular.module("festima")),angular.module("festima").service("positions",["$http","appConfig",function(e,t){angular.extend(this,{listAllByBuilding:function(n){return e.get(t.apiUrl+"/positions",{params:{buildingId:n}})},createPosition:function(n){return e.post(t.apiUrl+"/positions",n).then(function(e){return e.data})},"delete":function(n){return e["delete"](t.apiUrl+"/positions/"+n)}})}]),angular.module("festima").service("dealers",["$http","appConfig",function(e,t){angular.extend(this,{findAllByQuery:function(n){return e.get(t.apiUrl+"/dealers",{params:{q:n}}).then(function(e){return e.data})},listAll:function(){return e.get(t.apiUrl+"/dealers").then(function(e){return e.data})},mapAll:function(){return this.listAll().then(function(e){for(var t,n={},i=0;i<e.length;i++)t=e[i],angular.isUndefined(n[t.id])&&(n[t.id]=t);return n})},listByIds:function(n){for(var i="?",r=0;r<n.length;r++)i+="&id="+n[r];return e.get(t.apiUrl+"/dealers"+i)}})}]),angular.module("festima").factory("buildingsManager",["$http","$q","appConfig","Building","usersManager","dictionaries",function(e,t,n,i,r,o){var a={_pool:{},_retrieveInstance:function(e,t){var n=this._pool[e];return n?n.setData(t):(n=new i(t),this._pool[e]=n),n},_search:function(e){return this._pool[e]},_load:function(t,i){var r=this;e.get(n.apiUrl+"/buildings/"+t).success(function(e){var t=e,n=r._retrieveInstance(t.id,t);i.resolve(n)}).error(function(){i.reject()})},getBuilding:function(e){var n=t.defer(),i=this._search(e);return i?n.resolve(i):void 0===e?n.resolve(this._retrieveInstance(null)):this._load(e,n),n.promise},loadAllBuildings:function(){var i=t.defer(),r=this;return e.get(n.apiUrl+"/buildings").success(function(e){var t,n=[];return 0==e.length?void i.resolve([]):void e.forEach(function(e){t=r._retrieveInstance(e.id,e),n.push(t),i.resolve(n)})}).error(function(){i.reject()}),i.promise},setBuilding:function(e){var t=this,n=this._search(e.id);return n?n.setData(e):n=t._retrieveInstance(e),n}};return a}]),angular.module("festima").factory("buildingDealersManager",["$http","$q","BuildingDealer","dealers",function(e,t,n,i){var r={_pool:{},_retrieveInstance:function(e,t){var i=this._pool[e];if(i)i.setData(t);else if(i=new n(t),e)this._pool[e]=i;else{var r=Math.min(-1,Math.min(Object.keys(this._pool)));i.id=r,this._pool[r]=i}return i},_unsaved:function(){var e=[],t=this;return Object.keys(this._pool).forEach(function(n){Number(n)<0&&e.push(t._pool[n])}),e},_search:function(e){return this._pool[e]},_load:function(t,n){var i=this;e.get("http://localhost:3000/api/buildingDealers/"+t).success(function(t){var r=i._retrieveInstance(t.id,t);e.get("http://localhost:3000/api/dealers/"+t.dealerId).then(function(e){r.dealer=e.data}),n.resolve(r)}).error(function(){n.reject()})},getBuildingDealer:function(e){var n=t.defer(),i=this._search(e);return i?n.resolve(i):this._load(e,n),n.promise},loadAllBuildingDealers:function(n){var r=t.defer(),o=this;return e.get("http://localhost:3000/api/buildingDealers",{params:{buildingId:n}}).success(function(e){var t=[],n={};return e.forEach(function(e){var i=o._retrieveInstance(e.id,e);t.push(i),n[i.dealerId]=i}),i.listByIds(Object.keys(n)).then(function(e){var i=e.data;i.forEach(function(e){n[e.id].dealer=e}),r.resolve(t)})}).error(function(){r.reject()}),r.promise},setBuildingDealer:function(e){var t=this,n=this._search(e.id);return n?n.setData(e):n=t._retrieveInstance(null,e),n}};return r}]),angular.module("festima").service("buildingDealersService",["dealers","positions",function(e,t){angular.extend(this,{getDealersPositionsMap:function(n){return t.listAllByBuilding(n).then(function(t){var n={},i=t.data;return e.mapAll().then(function(e){for(var t,r=0;r<i.length;r++)t=i[r].dealer.id,angular.isUndefined(n[t])&&(n[t]={name:e[t].name,positions:[]}),n[t].positions.push(i[r]);return n})})},saveDealerPositions:function(e,n){for(var i,r=0;r<n.length;r++)i=n[r],i.removed===!0&&t["delete"](i.id).then(function(){var e=n.map(function(e){return e.id}).indexOf(i.id);n.splice(e,1)}),angular.isUndefined(i.buildingId)&&(i.buildingId=i.building.id,delete i.building),angular.isUndefined(i.id)&&t.createPosition(i).then(function(e){i.id=e.id,console.log("Saved position "+i.id)})}})}]),angular.module("festima").factory("BuildingDealer",["$http",function(e){function t(e){e&&this.setData(e)}return t.prototype={setData:function(e){angular.extend(this,e)},save:function(){void 0===this.id?(e.post("http://localhost:3000/api/buildingDealers",this),e.get("http://localhost:3000/api/buildingDealers").then(function(e){angular.extend(this,e.data)})):this.update()},"delete":function(){e["delete"]("http://localhost:3000/api/buildingDealers/"+id)},update:function(){e.put("http://localhost:3000/api/buildingDealers/"+id,this)}},t}]),angular.module("festima").controller("BuildingShowController",["$stateParams","buildingsManager","maps",function(e,t,n){var i=e.buildingId,r=this;t.getBuilding(i).then(function(e){r.building=e,DG.then(function(){var e,t,i,o=n.centroidToLatlng(r.building.location);t=o[0],i=o[1],e=DG.map("map",{center:o,zoom:16}),DG.marker(o).addTo(e).bindPopup("Вы кликнули по мне!")})})}]),angular.module("festima").factory("Building",["$http","appConfig",function(e,t){function n(e){e&&this.setData(e)}return n.prototype={setData:function(e){angular.extend(this,e)},save:function(){return e.post(t.apiUrl+"/buildings",this).then(function(e){return e.data})},"delete":function(){e["delete"](t.apiUrl+"/buildings/"+this.id)},update:function(){e.put(t.apiUrl+"/buildings/"+this.id,this)}},n}]),angular.module("festima").controller("BuildingListController",["$scope","buildingsManager",function(e,t){var n=this;angular.extend(n,{buildings:[]}),t.loadAllBuildings().then(function(e){n.buildings=e})}]),angular.module("festima").controller("BuildingEditController",["$stateParams","$location","toastr","buildingsManager","buildingDealersService",function(e,t,n,i,r){var o=this;o.buildingId=e.buildingId,i.getBuilding(o.buildingId).then(function(e){o.building=e},function(){n.info("Объект не найден"),t.url("/building/list")}),r.getDealersPositionsMap(o.buildingId).then(function(e){o.dealersPositionsMap=e}),o.addDealerPosition=function(e,t){o.dealersPositionsMap[e].positions.push(t)},o.removeDealerPosition=function(e,t){var n=o.dealersPositionsMap[e].positions;if(void 0===t.id){var i=n.indexOf(t);-1!==i&&n.splice(i,1)}else t.removed=!0},o.addDealer=function(e){o.isAddedDealer(e)||(o.dealersPositionsMap[e.id]={name:e.name,positions:[]})},o.isAddedDealer=function(e){var t=Object.keys(o.dealersPositionsMap).indexOf(String(e.id));return t>=0},o.saveChanges=function(){o.building.update();for(var e in o.dealersPositionsMap)r.saveDealerPositions(e,o.dealersPositionsMap[e].positions);t.path("/building/show/"+o.building.id)},o.onSelectAddress=function(e){o.building.address=e.full_name,o.building.location=e.geometry.centroid}}]),angular.module("festima").controller("BuildingCreateController",["$location","Building","toastr",function(e,t,n){var i=this;i.building=new t,i.saveChanges=function(){i.building.save().then(function(t){i.buildingId=t.id,i.building=t,e.path("/building/show/"+i.building.id)}),n.success('Новый объект "'+i.building.name+'" добавлен!')},i.onSelectAddress=function(e){i.addressObject=e,i.building.address=e.full_name,i.building.location=e.geometry.centroid}}]),function(e){"use strict";e.service("addresses",["$q","$http","appConfig",function(e,t,n){angular.extend(this,{listWithinRadius:function(i,r){var o=e.defer();return t.get(n.apiUrl+"/buildings",{params:{latlng:i,radius:r}}).then(function(e){console.log("Found addresses:",e.data),o.resolve(e.data)},function(){o.reject()}),o.promise}})}])}(angular.module("festima")),function(e){"use strict";e.controller("AddressListController",["_","maps","addresses",function(e,t,n){var i=this;i.onSelectAddress=function(e){i.addressObject=e}}])}(angular.module("festima")),function(){"use strict";function e(e){e.debug("runBlock end")}e.$inject=["$log"],angular.module("festima").run(e).run(["$rootScope","$window","OAuth",function(e,t,n){e.$on("oauth:error",function(e,i){return"invalid_grant"!==i.data.error?"invalid_token"===i.data.error?n.getRefreshToken():t.location.href="/login?error_reason="+i.data.error:void 0})}])}(),function(){"use strict";function e(e,t){e.state("private",{url:"","abstract":!0,views:{app:{templateUrl:"app/layouts/private-layout.html"}},resolve:{loggedin:["session",function(e){return e.checkLoggedIn()}]}}).state("private.logout",{url:"/logout",resolve:{loggedout:["session",function(e){return e.logout()}]}}).state("private.main",{url:"/",views:{"container@private":{templateUrl:"app/main/main.html",controller:"MainController",controllerAs:"main"}}}).state("private.buildinglist",{url:"/building/list",views:{"container@private":{templateUrl:"app/building/building-list.html",controller:"BuildingListController",controllerAs:"vm"}}}).state("private.buildingshow",{url:"/building/show/:buildingId",views:{"container@private":{templateUrl:"app/building/building-show.html",controller:"BuildingShowController",controllerAs:"buildingVm"}}}).state("private.buildingedit",{url:"/building/edit/:buildingId",views:{"container@private":{templateUrl:"app/building/building-edit.html",controller:"BuildingEditController",controllerAs:"vm"}}}).state("private.buildingcreate",{url:"/building/create",views:{"container@private":{templateUrl:"app/building/building-create.html",controller:"BuildingCreateController",controllerAs:"vm"}}}).state("private.addresslist",{url:"/address/list",views:{"container@private":{templateUrl:"app/address/address-list.html",controller:"AddressListController",controllerAs:"vm"}}}).state("private.dictionarieslist",{url:"/dictionaries/list",views:{"container@private":{templateUrl:"app/dictionary/dictionary-list.html",controller:"DictionaryListController",controllerAs:"vm"}}}).state("private.dictionaryshow",{url:"/dictionaries/:key",views:{"container@private":{templateUrl:"app/dictionary/dictionary-show.html",controller:"DictionaryShowController",controllerAs:"vm"}}}).state("public",{url:"","abstract":!0,views:{app:{templateUrl:"app/layouts/public-layout.html"}}}).state("public.login",{url:"/login",views:{"container@public":{templateUrl:"app/login/login.html",controller:"LoginController",controllerAs:"vm"}},resolve:{skipLoggedIn:["session",function(e){return e.skipLoggedIn()}]}}).state("public.about",{url:"/about",views:{"container@public":{templateUrl:"app/main/about.html",controller:"AboutController",controllerAs:"about"}}}),t.otherwise("/")}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("festima").config(e)}(),function(){"use strict";angular.module("festima").constant("malarkey",malarkey).constant("moment",moment).constant("_",window._).constant("appConfig",{apiUrl:"http://localhost:8080/api"})}(),function(){"use strict";function e(e,t){e.debugEnabled(!0),t.allowHtml=!0,t.timeOut=3e3,t.positionClass="toast-top-right",t.preventDuplicates=!0,t.progressBar=!0}function t(e,t){return{response:function(e){return e},responseError:function(n){return 401===n.status&&t.url("/login"),e.reject(n)}}}e.$inject=["$logProvider","toastrConfig"],t.$inject=["$q","$location"],angular.module("festima").config(e).config(["OAuthProvider",function(e){e.configure({grantPath:"/oauth/token",revokePath:"/oauth/revoke",baseUrl:"http://localhost:8080",clientId:"estima-client",options:{secure:!1}})}]).config(["OAuthTokenProvider",function(e){e.configure({name:"token",options:{secure:!1}})}]).config(["$httpProvider",function(e){e.interceptors.push(["$injector",function(e){return e.get("AuthInterceptor")}])}]).factory("AuthInterceptor",t)}();
//# sourceMappingURL=../maps/scripts/app-243535b9f2.js.map
